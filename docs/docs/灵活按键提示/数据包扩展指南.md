---
sidebar_position: 0
---

# 数据包扩展指南

## 概述

SmartKeyPrompts 支持通过**数据包**扩展按键提示功能，允许不精通 Kubejs 的整合包作者与玩家根据实际需求灵活自定义按键显示

---

## 数据包结构

### 文件路径

数据包文件应存放于：

```
data/[namespace]/smartkeyprompts/key_prompts/[文件名].json
```

例如：
`data/smartkeyprompts/smartkeyprompts/key_prompts/tacz.json`

### 文件格式

```json
{
  "modid": "模组标识符",
  "vars": {
    "变量名": "MVEL 表达式"
  },
  "entries": [
    {
      "when": {
        "条件变量": "期望值或表达式"
      },
      "then": [
        "动作表达式"
      ]
    }
  ]
}
```

---

## 字段说明

### `modid`

* 类型：`string`
* 说明：用于标识此数据包所属模组。

### `vars`

* 类型：`object`
* 说明：定义可复用变量，通过 MVEL 表达式实时计算，用于简化条件判断。

### `entries`

* 类型：`array`
* 说明：一组触发条件与响应动作的配对逻辑，按顺序逐一执行。

#### `when`

* 类型：`object`
* 说明：触发条件，所有键值对需同时满足。
* 支持：

    * 精确匹配
    * 通配符匹配（如 `"immersive_aircraft:*"`）
    * 表达式匹配（如 `"modLoaded": "true"`）

#### `then`

* 类型：`string[]`
* 说明：当 `when` 条件满足时执行的动作表达式。

---

## 内置函数参考（可提 Issue 作者酌情添加）

### 模组检测

* `isModLoaded(modid)`：检查指定模组是否加载

### 玩家状态

* `getMainHandItemId(player)`：获取主手物品 ID
* `getVehicleType(player)`：获取当前载具类型
* `isInVehicle()`：是否在载具中
* `isCreativeMode()`：是否处于创造模式
* `hasItem(itemId)`：是否持有指定物品

### 按键相关

* `getKeyByDesc(desc)`：通过描述获取按键绑定
* `getKeyShift()`：获取“潜行”键
* `getKeyUse()`：获取“使用”键
* `getKeyJump()`：获取“跳跃”键
* `getKeyInventory()`：获取“背包”键
* `translateKey(key)`：翻译按键名称
* `isKeyPressedOfDesc(desc)`：检查按键是否按下

### 目标检测

* `getTargetType()`：获取目标实体类型
* `isTargetedEntityType(entityType)`：检查目标实体是否为指定类型

### 界面状态

* `isCameraPlayer()`：摄像机视角是否为玩家
* `isScreenOpen()`：是否有界面打开

### 显示动作

* `show(modid, translationKey)`：显示普通按键提示
* `custom(modid, key, translationKey)`：显示指定按键的提示

---

## 使用示例

### 示例 1：TACZ 模组支持

```json
{
  "modid": "tacz_skp",
  "vars": {
    "modLoaded": "isModLoaded('tacz')",
    "hasTaczGun": "mainHandItem == 'tacz:modern_kinetic_gun'",
    "isNotInVehicle": "!isInVehicle()"
  },
  "entries": [
    {
      "when": {
        "modLoaded": "true",
        "hasTaczGun": "true",
        "isNotInVehicle": "true"
      },
      "then": [
        "show('tacz_skp', 'key.tacz.shoot.desc')",
        "show('tacz_skp', 'key.tacz.zoom.desc')",
        "show('tacz_skp', 'key.tacz.reload.desc')"
      ]
    }
  ]
}
```

### 示例 2：通配符匹配（载具支持）

```json
{
  "modid": "immersive_aircraft_skp",
  "vars": {
    "modLoaded": "isModLoaded('immersive_aircraft')",
    "vehicleType": "vehicleType",
    "keyInventory": "getKeyInventory()"
  },
  "entries": [
    {
      "when": {
        "modLoaded": "true",
        "vehicleType": "immersive_aircraft:*"
      },
      "then": [
        "custom(modid, keyInventory, 'immersive_aircraft.slot.upgrade')",
        "show(modid, 'key.immersive_aircraft.dismount')"
      ]
    }
  ]
}
```

### 示例 3：组合按键与复杂条件

```json
{
  "modid": "diligentstalker",
  "vars": {
    "modLoaded": "isModLoaded('diligentstalker')",
    "keyUse": "getKeyByDesc('key.use')",
    "keyShift": "getKeyShift()",
    "isTargetedDrone": "isTargetedEntityType('diligentstalker:drone_stalker')"
  },
  "entries": [
    {
      "when": {
        "modLoaded": "true",
        "isTargetedDrone": "true",
        "mainHandItem": "minecraft:sugar",
        "screenOpen": "false"
      },
      "then": [
        "custom(modid, keyShift + '+' + keyUse, 'key.diligentstalker.add_fuel')"
      ]
    }
  ]
}
```

---

## 高级特性

### 变量系统

定义变量用于复用表达式、提高性能与可读性：

```json
"vars": {
  "hasSpecialItem": "hasItem('mod:special_item')",
  "isInCombat": "targetedEntity != null",
  "combinedKey": "getKeyShift() + '+' + getKeyUse()"
}
```

### 条件匹配形式

* **精确匹配**：

```json
"mainHandItem": "minecraft:diamond_sword"
```

* **通配符匹配**：

```json
"vehicleType": "immersive_aircraft:*"
```

* **表达式匹配**：

```json
"modLoaded": "true"
```

---

## 动作类型说明

| 表达式                                        | 说明           |
| ------------------------------------------ | ------------ |
| `show(modid, 'translation.key')`           | 显示标准按键提示     |
| `custom(modid, key, 'desc')`               | 显示指定按键的自定义提示 |
| `custom(modid, key1 + '+' + key2, 'desc')` | 组合键提示        |

---

## 最佳实践

1. **命名规范**

    * `modid`：使用 `<原模组名>_skp` 格式（表明是本模组主动提供的按键支持）
    * 变量名采用驼峰命名法
    * 提示文本使用翻译键（`modid.key.desc`）

2. **性能优化**

    * 优先使用精确匹配代替表达式匹配
    * 将复杂逻辑提取为 `vars`
    * 条件顺序以常见优先

3. **可维护性**

    * 按模组拆分文件
    * 合理分组 `entries`
    * 保持表达式简洁、变量命名清晰

4. **兼容性考量**

    * 始终检查模组是否加载
    * 处理空值和异常情况
    * 考虑不同游戏状态（如界面打开、视角切换等）

---

## 常见问题解答（FAQ）

**Q: 为什么提示没有显示？**

A：请检查：

* 模组是否正确加载
* 条件是否设定正确
* 表达式语法是否有误
* 是否存在互斥条件

**Q: 一个 JSON 文件可以支持多个模组吗？**

A：不推荐。建议每个模组一个文件以保持清晰和可维护。

需要更多帮助时，也欢迎查阅相关模组源码或联系作者社区。
